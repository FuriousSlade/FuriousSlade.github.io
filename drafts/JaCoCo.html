<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, height=device-width, initial-scale=1">
    <meta name="author" content="Slade" />
    <meta name="copyright" content="Slade" />
    <meta property="og:type" content="article" />

<meta name="keywords" content="JaCoCo, 笔记, " />

    <title>JaCoCo代码覆盖率实践笔记</title>
<script type="text/javascript" src="/theme/js/jquery-1.12.0.min.js"></script>
<script type="text/javascript" src="/theme/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/theme/tipuesearch/tipuesearch_set.js"></script>
<script type="text/javascript" src="/theme/tipuesearch/tipuesearch.min.js"></script>
<link rel="stylesheet" href="/theme/css/bootstrap.min.css" />
<link rel="stylesheet" href="/theme/css/font-awesome.min.css" />
<link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
<link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
<link rel="stylesheet" type="text/css" href="/theme/css/swain.css" media="screen">
<link rel="stylesheet" type="text/css" href="/theme/css/animate.css" media="screen">
    <link rel="icon" href="/theme/images/favicon.ico" type="image/x-icon" />
    
    <!-- GOOGLE_ANALYTICS -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-75717198-1', 'auto');
      ga('send', 'pageview');
    </script>
</head>
<body>
    <!-- navbar start -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid" style="max-width: 1280px">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-bars fa-lg"></i>
                </button>
                <a class="navbar-brand" href="/">Chihiro.moe</a>
            </div>

            <div class="collapse navbar-collapse navbar-right" id="navbar-collapse-1">
                <ul class="nav navbar-nav">
 <!--                    <li ><a href="/">Home</a></li>
                        <li ><a href="/pages/links.html">友链</a></li>
                    <li ><a href="/categories.html">Categories</a></li>
                    <li ><a href="/tags.html">Tags</a></li>
                    <li ><a href="/archives.html">Archives</a></li> -->
                    <li class="dropdown">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">  JaCoCo代码覆盖率实践笔记  <span class="caret"></span></a>
                      <ul class="dropdown-menu dropdown-menu-right">
                        <li><a href="/">Index</a></li>
                        <li><a href="/categories.html">Categories</a></li>
                        <li><a href="/tags.html">Tags</a></li>
                        <li><a href="/archives.html">Archives</a></li>
                        <li><a href="/pages/links.html">Links</a></li>
                      </ul>
                    </li>                    
                </ul>
                <form class="navbar-search navbar-form navbar-right" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);">
                  <input type="text" class="search-query form-control" placeholder="Search" name="q" id="tipue_search_input" required>
                </form>
            </div>
        </div>
    </nav>
    <!-- navbar end -->
    <div class="container-fluid" id="container" style="max-width: 1280px">
        <div class="row-fluid">
<div class="col-md-2 hidden-xs hidden-sm" id="sidebar_left">
<div id="toc">
  <div class="panel panel-default">
    <div class="panel-body nav">
      <div class="toc">
<ul>
<li><a href="#_1">主要工具</a><ul>
<li><a href="#jenkins">Jenkins</a></li>
<li><a href="#ant">Ant</a></li>
<li><a href="#jacoco">JaCoCo</a></li>
</ul>
</li>
<li><a href="#_2">代码覆盖率获取过程</a><ul>
<li><a href="#_3">背景</a></li>
<li><a href="#jacocoagent">部署Jacocoagent</a></li>
<li><a href="#ubuntuant">Ubuntu上安装ant</a></li>
<li><a href="#_4">调试</a></li>
</ul>
</li>
</ul>
</div>
    </div>
  </div>
</div>
<script type="text/javascript">
  $('body').scrollspy();
  $('.toc a').each(function(){
    $(this).attr({"data-toggle":"tooltip",
                "data-placement":"top",
                "title":$(this).text()
                });
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
    });
  });
</script>
</div>
            <div class="col-md-8" id="center_page">
<section id="content" class="body">
  <article>
    <div class="panel panel-default">
      <div class="panel-body">
        <header>
          <h2 class="entry-title">
            <a href="/drafts/JaCoCo.html" rel="bookmark"
               title="Permalink to JaCoCo代码覆盖率实践笔记">JaCoCo代码覆盖率实践笔记</a></h2>
        </header>
        <hr/>
        <div class="entry-content">
          
<p>测试用例(产品需求)的覆盖率，往往很容易达到较高的水准。但这不代表测试覆盖到了代码运行时所有的可能性。为了更好的覆盖到方方面面，引入代码覆盖率来进一步的提升自动化测试的覆盖率。</p>
<p>通过查看各类技术博客，选择使用JaCoCo来获取代码覆盖率。原因的话是JaCoCo对Java8的支持，以及可以在程序运行时获取程序执行信息。</p>
<p>大多数博客介绍的都是本地代码执行来获取覆盖率，我面对的情况是被测服务分布式的部署在测试环境。在实践过程中走了点弯路，记下笔记。</p>
<h3 id="_1">主要工具</h3>
<h4 id="jenkins">Jenkins</h4>
<blockquote>
<p>Jenkins是一个用Java编写的开源的持续集成工具。</p>
<p>Jenkins提供了软件开发的持续集成服务。可以执行基于Apache Ant和Apache Maven的项目，以及任意的Shell脚本和Windows批处理命令。</p>
<p>可以通过各种手段触发构建。例如提交给版本控制系统时被触发，也可以通过类似Cron的机制调度，也可以在其他的构建已经完成时，还可以通过一个特定的URL进行请求。</p>
</blockquote>
<p>Jenkins是优秀的持续集成工具，在配合丰富的插件。基本上不需要写什么代码，就能满足大多数持续集成的需求。</p>
<p>我主要利用 Jenkins 建立参数化的Job（构建代码覆盖率报告）。</p>
<p>自动或手工触发Job。</p>
<p>持续从内部 gitlab 更新项目源码（用于生成代码覆盖率报告）。</p>
<p>调度 Jaococo ant 工具来生成代码覆盖率，并发送邮件等相关工作。</p>
<h4 id="ant">Ant</h4>
<blockquote>
<p>Apache Ant，是一个将软件编译、测试、部署等步骤联系在一起加以自动化的一个工具，大多用于Java环境中的软件开发。</p>
</blockquote>
<p>使用Ant的原因：</p>
<p>ANT本身就是一个流程脚本引擎，用于自动化调用程序。</p>
<p>有ssh 和 scp 的需求，但因为一些条件限制无法使用密钥对验证的情况下。Ant 可调用库 jsch-0.1.54.jar 提供在shell脚本中使用 ssh 和 scp 且可配置密码的方式访问远端，无需手工输入密码。</p>
<p>jacocoant.jar 生成代码覆盖率报告</p>
<h4 id="jacoco">JaCoCo</h4>
<p>Jacocoagent.jar 用于收集代码执行时的信息并在请求时导出数据。<a href="https://www.jacoco.org/jacoco/trunk/doc/agent.html" target='"_blank'>Java Agent 官方文档</a></p>
<p>Jacocoant.jar 用于Jenkins Job执行中获取远端 agent数据的收集和报表的生成。<a href="https://www.jacoco.org/jacoco/trunk/doc/index.html" target='"_blank'>Jacoco Ant 官方文档</a></p>
<h3 id="_2">代码覆盖率获取过程</h3>
<h4 id="_3">背景</h4>
<ol>
<li>Java Maven 项目。</li>
<li>公司发布系统，分布式部署，需要对多台服务器收集数据。</li>
<li>自用的Jenkins部署在一台Ubuntu系统的服务器上。</li>
<li>无法使用密钥对验证ssh到测试服务器，只能通过密码验证。</li>
</ol>
<h4 id="jacocoagent">部署Jacocoagent</h4>
<p>先从<a href="https://www.jacoco.org/jacoco/" target='"_blank'>JaCoCo</a>官网下载 jacoco-*.zip 包，下载解压后就有我们需要的 jacocoagent.jar 和 jacocoant.jar。</p>
<p>jacocoagent.jar 用于部署在被测服务端，收集覆盖率数据。</p>
<p>将 jacocoagent.jar scp到远端服务器目录下,例如:</p>
<div class="highlight"><pre><span></span>scp jacocoagent.jar username@remoterserver:/data/jacocoagent.jar
</pre></div>
<p>修改java项目启动时的 jvm 参数，增加：</p>
<div class="highlight"><pre><span></span>-javaagent:/data/jacocoagent.jar=output=tcpserver,address=*,port=8338,classdumpdir=/data/dump
</pre></div>
<p>重启服务</p>
<p>将 jacocoant.jar 放到本地Ubuntu服务器 <code>/data/jacocoant.jar</code></p>
<h4 id="ubuntuant">Ubuntu上安装ant</h4>
<div class="highlight"><pre><span></span>sudo apt-get install ant

# 创建目录
mkdir -p ~/.ant/lib
</pre></div>
<p>下载JSch至 ~/.ant/lib 目录内，因为原下载地址被墙，<a href="https://pan.baidu.com/s/1-51QQSorenNs3v8-0CSLRA" target='"_blank'>网盘JSch</a></p>
<h4 id="_4">调试</h4>
<p>jacoco 统计覆盖并生成报表需要三部分数据</p>
<ul>
<li>通过jacocoant 获取远端 jacocoagent 的覆盖率统计数据 jacoco.exec</li>
<li>远端服务执行中class文件</li>
<li>项目源码</li>
</ul>
<p><strong>完整的 ant 构建所需 build.xml</strong></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" ?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">name=</span><span class="s">"coverage"</span> <span class="na">xmlns:jacoco=</span><span class="s">"antlib:org.jacoco.ant"</span> <span class="nt">&gt;</span>
  <span class="nt">&lt;taskdef</span> <span class="na">uri=</span><span class="s">"antlib:org.jacoco.ant"</span> <span class="na">resource=</span><span class="s">"org/jacoco/ant/antlib.xml"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- 让ant找到jacocoant.jar --&gt;</span>
    <span class="nt">&lt;classpath</span> <span class="na">path=</span><span class="s">"/data/jacocoant.jar"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/taskdef&gt;</span>

  <span class="c">&lt;!-- 用于重置jacocoagent的数据 --&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">"reset"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jacoco:dump</span> <span class="na">address=</span><span class="s">"${remote_host}"</span>
      <span class="na">reset=</span><span class="s">"true"</span> <span class="na">destfile=</span><span class="s">"/dev/null"</span>
      <span class="na">port=</span><span class="s">"8335"</span> <span class="na">append=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/target&gt;</span>

  <span class="c">&lt;!-- 用于获取远端覆盖率数据 --&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">"dump"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;delete</span> <span class="na">file=</span><span class="s">"jacoco.exec"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;jacoco:dump</span> <span class="na">address=</span><span class="s">"${remote_host}"</span>
      <span class="na">reset=</span><span class="s">"false"</span>
      <span class="na">destfile=</span><span class="s">"jacoco.exec"</span>
      <span class="na">port=</span><span class="s">"8335"</span>
      <span class="na">append=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;delete</span> <span class="na">dir=</span><span class="s">"dump"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;sshexec</span> <span class="na">host=</span><span class="s">"${remote_host}"</span>
      <span class="na">username=</span><span class="s">"${username}"</span>
      <span class="na">password=</span><span class="s">"${password}"</span>
      <span class="na">trust=</span><span class="s">"true"</span>
      <span class="na">command=</span><span class="s">"cd /data;tar -czf dump.tar.gz dump"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;scp</span> <span class="na">file=</span><span class="s">"${username}:${password}@remote_host:/data/dump.tar.gz"</span> <span class="na">todir=</span><span class="s">"./"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;untar</span> <span class="na">src=</span><span class="s">"dump.tar.gz"</span> <span class="na">compression=</span><span class="s">"gzip"</span> <span class="na">dest=</span><span class="s">"dump"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;delete</span> <span class="na">dir=</span><span class="s">"dump.tar.gz"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/target&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</pre></div>
        </div><!-- /.entry-content -->

        <div class="social-share" data-sites="weibo,facebook,twitter"></div>
        <link rel="stylesheet" href="/theme/css/share.min.css">
        <script src="/theme/js/jquery.share.min.js"></script>
        
    </div>
  </div>      

  </article>
</section>
            </div>
            <div class="col-md-2" id="sidebar_right">
<div class="panel panel-default">
  <!-- <div class="panel-heading">Article <i class="fa fa-info-circle"></i>nfo</div> -->
    <div class="panel-body">
      <div class="published">
                <h5>Published</h5>
                <p><time>Jun 05, 2018</time></p>
      </div>
      <div class="modified">
                <h5>Updated</h5>
                <p><time>Jun 05, 2018</time></p>
      </div>
      <div class="category">
              <h5>Category</h5>
              <p><a class="btn btn-default btn-xs" style="text-transform:none" type="button" href="/categories.html#bi-ji-ref">笔记</a></p>
      </div>
      <div class="tags">
            <h5>Tags</h5>
            <ul class="list-inline list-of-tags tags-in-article">
                <li><a class="btn btn-default btn-xs" style="text-transform:none" type="button" href="/tags.html#jacoco-ref">JaCoCo
</a></li>
            </ul>
      </div>
      <address class="vcard author">
                By       <a href="mailto:175439093@qq.com">Slade</a>
      </address>

    </div>
</div>            </div>
        </div>
    </div>
    <!-- Mascot go to top -->
    <a href="#"><img id="go_top_logo" src="" class="umaru"></a>

    <!-- BAIDU_TONGJI -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?903bed5b17c3ef49f843500c8cb1a1b0";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
    })();
    </script>

    <!-- footer -->
    <div id="push"></div>
<footer class="footer">
<div id="footer" class="text-center">
    <span class="site-name">Chihiro.moe</span> - <i class="fa fa-copyright" aria-hidden="true"></i> Qi.Wang
    Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>.
</div>
</footer>    
<script id="dsq-count-scr" src="//furiousslade.disqus.com/count.js" async></script>
<script type="text/javascript">
    function setTocClass() {
        var f = document.getElementById("toc");
        if (f != null) {
          f.classList.add("art-toc");
        };
    };
    window.onload = setTocClass();
</script>
</body>
</html>
<script type="text/javascript">
  function validateForm(query) {
    return (query.length > 0);
  };
  var dropdownStatus = false
  $(document).ready(function(){
      $(function() {
        $(window).scroll(function() {
          if($(this).scrollTop()>20) {
            $("body > nav").css("background-color", "rgba(255, 255, 255, 0.5)");
          } else {
            $("body > nav").css("background-color", "rgba(255, 255, 255, 1)");
          }
        });
      });
      $("body > nav").mouseover(function() {
        $(this).css("background-color", "rgba(255, 255, 255, 1)");
      });
      $("#navbar-collapse-1").on('shown.bs.collapse', function() {
          $('.dropdown-toggle').dropdown('toggle');
          dropdownStatus = true;
      });
      $(".dropdown-toggle").mouseenter(function(){
          $('.dropdown-toggle').dropdown('toggle');
          dropdownStatus = true;
      });
      $("#container").mouseenter(function(){
          if (dropdownStatus == true) {
              $('.dropdown-toggle').dropdown('toggle');
              dropdownStatus = false;
          };
      });    
  });
  var character_list = [{"img_url":"/theme/images/umaru02.png"},{"img_url":"/theme/images/kanna02.png"}];
  var random_value=parseInt(Math.random()*2);
  var character=character_list[random_value];
  document.getElementById("go_top_logo").src=character["img_url"];
</script>